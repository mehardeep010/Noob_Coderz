const express = require('express');
const multer = require('multer');
const path = require('path');
const { spawn } = require('child_process');
const fs = require('fs');

const app = express();
const PORT = process.env.PORT || 3000;

// Configure multer for file uploads
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        const uploadDir = 'uploads';
        if (!fs.existsSync(uploadDir)) {
            fs.mkdirSync(uploadDir);
        }
        cb(null, uploadDir);
    },
    filename: function (req, file, cb) {
        cb(null, Date.now() + '-' + file.originalname);
    }
});

const upload = multer({ 
    storage: storage,
    limits: {
        fileSize: 50 * 1024 * 1024 // 50MB limit
    },
    fileFilter: function (req, file, cb) {
        if (file.mimetype === 'application/pdf') {
            cb(null, true);
        } else {
            cb(new Error('Only PDF files are allowed!'), false);
        }
    }
});

// Middleware
app.use(express.static('.'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// CORS headers
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept, Authorization');
    next();
});

// Main route - serve the HTML file
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

// Health check endpoint
app.get('/health', (req, res) => {
    res.json({ 
        status: 'healthy', 
        timestamp: new Date().toISOString(),
        version: '2.0.0'
    });
});

// PDF processing endpoint
app.post('/generate-funny-pdf', upload.single('pdf'), (req, res) => {
    console.log('ğŸ“„ PDF generation request received');
    
    if (!req.file) {
        console.error('âŒ No PDF file uploaded');
        return res.status(400).json({ error: 'No PDF file uploaded' });
    }

    const inputPath = req.file.path;
    const outputPath = path.join(__dirname, `funny_${Date.now()}.pdf`);
    
    console.log(`ğŸ“‚ Input file: ${inputPath}`);
    console.log(`ğŸ“‚ Output file: ${outputPath}`);
    
    // Extract parameters from request
    const {
        humorStyle = 'mild',
        catFrequency = '3',
        enableEmojis = 'false',
        enableCats = 'false',
        enableAI = 'false',
        apiKey = ''
    } = req.body;

    console.log('ğŸ­ Generation parameters:', {
        humorStyle,
        catFrequency,
        enableEmojis,
        enableCats,
        enableAI: enableAI === 'true' ? 'yes (with API key)' : 'no'
    });
    
    // Build Python command arguments
    const pythonArgs = [
        'funnyify.py',
        inputPath,
        outputPath,
        '--style', humorStyle,
        '--cat-frequency', catFrequency
    ];
    
    // Add optional flags
    if (enableEmojis === 'true') {
        pythonArgs.push('--emojis');
    }
    
    if (enableCats === 'true') {
        pythonArgs.push('--cats');
    }
    
    if (enableAI === 'true' && apiKey) {
        pythonArgs.push('--ai', '--api-key', apiKey);
    }

    console.log('ğŸ Running Python script with args:', pythonArgs);
    
    // Try different Python commands
    const pythonCommands = ['python', 'python3', 'py'];
    let pythonCmd = 'python';
    
    // Determine which Python command works
    for (const cmd of pythonCommands) {
        try {
            const testProcess = spawn(cmd, ['--version'], { stdio: 'pipe' });
            testProcess.on('close', (code) => {
                if (code === 0) {
                    pythonCmd = cmd;
                }
            });
        } catch (e) {
            // Command not found, try next
        }
    }
    
    // Run the Python script
    const pythonProcess = spawn(pythonCmd, pythonArgs, {
        stdio: ['pipe', 'pipe', 'pipe']
    });
    
    let output = '';
    let error = '';
    
    pythonProcess.stdout.on('data', (data) => {
        const message = data.toString().trim();
        if (message) {
            output += message + '\n';
            console.log('ğŸ Python output:', message);
        }
    });
    
    pythonProcess.stderr.on('data', (data) => {
        const message = data.toString().trim();
        if (message) {
            error += message + '\n';
            console.error('ğŸ Python error:', message);
        }
    });
    
    // Set timeout for the process (5 minutes)
    const timeout = setTimeout(() => {
        pythonProcess.kill();
        console.error('â° Python process timed out');
        cleanupFiles(inputPath, outputPath);
        res.status(500).json({ error: 'Processing timed out' });
    }, 5 * 60 * 1000);
    
    pythonProcess.on('close', (code) => {
        clearTimeout(timeout);
        
        console.log(`ğŸ Python process finished with code: ${code}`);
        
        if (code === 0 && fs.existsSync(outputPath)) {
            console.log('âœ… PDF generation successful');
            
            // Send the generated PDF
            res.download(outputPath, `funny_${req.file.originalname}`, (err) => {
                if (err) {
                    console.error('âŒ Error sending file:', err);
                } else {
                    console.log('ğŸ“¤ File sent successfully');
                }
                
                // Clean up files
                cleanupFiles(inputPath, outputPath);
            });
        } else {
            console.error('âŒ PDF generation failed');
            console.error('Error details:', error);
            
            // Clean up files
            cleanupFiles(inputPath, outputPath);
            
            res.status(500).json({ 
                error: 'PDF processing failed',
                details: error || 'Unknown error occurred',
                code: code
            });
        }
    });
    
    pythonProcess.on('error', (err) => {
        clearTimeout(timeout);
        console.error('âŒ Failed to start Python process:', err);
        cleanupFiles(inputPath, outputPath);
        
        res.status(500).json({ 
            error: 'Failed to start PDF processing',
            details: `Python command "${pythonCmd}" not found. Please ensure Python is installed and in your PATH.`
        });
    });
});

// Helper function to clean up temporary files
function cleanupFiles(...files) {
    files.forEach(file => {
        if (fs.existsSync(file)) {
            try {
                fs.unlinkSync(file);
                console.log(`ğŸ—‘ï¸ Cleaned up: ${file}`);
            } catch (err) {
                console.error(`âŒ Failed to clean up ${file}:`, err);
            }
        }
    });
}

// Error handling middleware
app.use((error, req, res, next) => {
    if (error instanceof multer.MulterError) {
        if (error.code === 'LIMIT_FILE_SIZE') {
            return res.status(400).json({ error: 'File too large. Maximum size is 50MB.' });
        }
    }
    
    console.error('âŒ Unhandled error:', error);
    res.status(500).json({ error: 'Internal server error' });
});

// 404 handler
app.use((req, res) => {
    res.status(404).json({ error: 'Endpoint not found' });
});

// Graceful shutdown
process.on('SIGINT', () => {
    console.log('\nğŸ›‘ Shutting down server...');
    
    // Clean up uploads directory
    const uploadDir = path.join(__dirname, 'uploads');
    if (fs.existsSync(uploadDir)) {
        const files = fs.readdirSync(uploadDir);
        files.forEach(file => {
            const filePath = path.join(uploadDir, file);
            try {
                fs.unlinkSync(filePath);
            } catch (err) {
                console.error(`Failed to clean up ${filePath}`);
            }
        });
    }
    
    process.exit(0);
});

// Start the server
app.listen(PORT, () => {
    console.log('ğŸ­=====================================ğŸ­');
    console.log('ğŸ‰ PDF Funnyify Server Started! ğŸ‰');
    console.log('ğŸ­=====================================ğŸ­');
    console.log(`ğŸŒ Server URL: http://localhost:${PORT}`);
    console.log(`ğŸ“± Mobile URL: http://localhost:${PORT}`);
    console.log('ğŸ­=====================================ğŸ­');
    console.log('ğŸ“– Features Available:');
    console.log('  â€¢ ğŸ“„ Beautiful PDF Viewer');
    console.log('  â€¢ ğŸ­ Funny PDF Generator');
    console.log('  â€¢ ğŸ± Cat Image Insertion');
    console.log('  â€¢ ğŸ˜‚ Emoji Sprinkling');
    console.log('  â€¢ ğŸ¤– AI Text Rewriting');
    console.log('  â€¢ ğŸ“± Mobile Responsive');
    console.log('ğŸ­=====================================ğŸ­');
    console.log('ğŸ’¡ Tips:');
    console.log('  â€¢ Drag & drop PDFs for quick upload');
    console.log('  â€¢ Use keyboard shortcuts in viewer');
    console.log('  â€¢ Try different humor styles!');
    console.log('ğŸ­=====================================ğŸ­');
    console.log('ğŸš€ Ready for some PDF fun! Open Chrome and go to the URL above!');
    console.log('');
});

// Export for testing
module.exports = app;
